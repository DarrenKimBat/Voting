<!DOCTYPE html>
<html>

<head>
    <title>Digital Vote</title>
    <meta charset=utf-8 />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://fonts.googleapis.com/earlyaccess/nanumgothic.css">
    <link rel="stylesheet" type="text/css" href="/css/style.css">
    <!-- Material Design Theming -->
    <link rel="stylesheet" href="https://code.getmdl.io/1.1.3/material.orange-indigo.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script defer src="https://code.getmdl.io/1.1.3/material.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.3.1/firebase.js"></script>
</head>

<body>

    <script src="https://www.gstatic.com/firebasejs/5.3.1/firebase.js"></script>

    <div id="title" style="vertical-align: baseline; text-align: center;">
        <h1 style="font-size: 36px;">CHAIN VOTING</h1>
        <img src="/images/main.png" alt="main_scene" width="20%" height="20%">
    </div>

    <div id="vote_scene" style="text-align: center">
        <form id="sign-in-form" action="#">
            <!-- Input to enter the phone number -->
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" type="text" id="voter_name">
                <label class="mdl-textfield__label" for="phone-number">이 름</label>
                <span class="mdl-textfield__error"></span>
            </div>
            <br>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" type="text" pattern="[0-9]{13}" id="voter_info_num">
                <label class="mdl-textfield__label" for="voter_info_num">주민 번호</label>
                <span class="mdl-textfield__error">13자리 혹은 숫자만 입력해주세요.</span>
            </div>
            <br>
            <div class="mdl-textfield mdl-js-textfield mdl-textfield--floating-label">
                <input class="mdl-textfield__input" type="text" pattern="[0-9\a-z\A-Z]" id="voter_prkey">
                <label class="mdl-textfield__label" for="voter_prkey">인증키</label>
                <span class="mdl-textfield__error">유효하지 않은 인증키 입니다.</span>
            </div>

            <!-- Sign-in button -->
            <br>
            <button disabled class="mdl-button mdl-js-button mdl-button--raised" id="sign-in-button">인증</button>
        </form>

    </div>

</body>

<script src="/__/firebase/5.0.0/firebase-app.js"></script>
<script src="/__/firebase/5.0.0/firebase-auth.js"></script>
<script src="/__/firebase/init.js"></script>
<script>
    window.onload = function () {
        // Listening for auth state changes.

        document.getElementById('voter_info_num').addEventListener('keyup', updateSignInButtonUI);
        document.getElementById('voter_info_num').addEventListener('change', updateSignInButtonUI);

        window.recaptchaVerifier = new firebase.auth.RecaptchaVerifier('sign-in-button', {
            'size': 'invisible',
            'callback': function (response) {
                // reCAPTCHA solved, allow signInWithPhoneNumber.
                onSignInSubmit();
            }
        });

        recaptchaVerifier.render().then(function (widgetId) {
            window.recaptchaWidgetId = widgetId;
            updateSignInButtonUI();
        });
    };

    function getPhoneNumberFromUserInput() {
        return document.getElementById('voter_info_num').value;
    }

    function onSignInSubmit() {
        if (isUserInfoValid()) {
            window.signingIn = true;
            updateSignInButtonUI();
            var phoneNumber = getPhoneNumberFromUserInput();
            var appVerifier = window.recaptchaVerifier;
            firebase.auth().signInWithPhoneNumber(phoneNumber, appVerifier)
                .then(function (confirmationResult) {
                    // SMS sent. Prompt user to type the code from the message, then sign the
                    // user in with confirmationResult.confirm(code).
                    window.confirmationResult = confirmationResult;
                    window.signingIn = false;
                    updateSignInButtonUI();
                    updateSignInFormUI();
                })
        }
    }


    function isUserInfoValid() {
        var pattern = "[0-9]{13}";
        var phoneNumber = getPhoneNumberFromUserInput();
        return phoneNumber.search(pattern) !== -1;
    }

    function updateSignInFormUI() {
        if (firebase.auth().currentUser || window.confirmationResult) {
            document.getElementById('sign-in-form').style.display = 'none';
        } else {
            resetReCaptcha();
            document.getElementById('sign-in-form').style.display = 'block';
        }
    }

    function updateSignInButtonUI() {
        document.getElementById('sign-in-button').disabled =
            !isPhoneNumberValid()
            || !!window.signingIn;
    }

    function updateVerifyCodeButtonUI() {
        document.getElementById('verify-code-button').disabled =
            !!window.verifyingCode
            || !getCodeFromUserInput();
    }
</script>

</html>